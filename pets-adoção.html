<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adote um Amigo - Pets Disponíveis</title>
    <!-- Carrega Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones Lucide -->
    <script type="module">
        import { createIcons, Search, Heart, PawPrint, MessageCircle, Dog, Cat, Bird, AlertCircle, PlusCircle } from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/esm/lucide.js';
        window.createIcons = createIcons;
        window.icons = { Search, Heart, PawPrint, MessageCircle, Dog, Cat, Bird, AlertCircle, PlusCircle };
        
        // Inicializa os ícones Lucide imediatamente após a importação no DOM
        document.addEventListener('DOMContentLoaded', () => {
            window.createIcons();
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --secondary-color: #f87171; /* Red 400 */
            --bg-light: #f7f8fa; /* Light Gray/Off-White */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            min-height: 100vh;
        }
        /* Estilos personalizados para o cartão de pet */
        .pet-card {
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white;
        }
        .pet-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Tela de Carregamento (agora com remoção mais direta no JS) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-gray-600">Carregando dados...</p>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-10 py-4 bg-white shadow-md rounded-lg">
            <h1 class="text-4xl font-extrabold text-gray-800 flex items-center justify-center">
                <i data-lucide="PawPrint" class="w-8 h-8 text-red-500 mr-3"></i>
                Adote um Amigo
            </h1>
            <p class="text-gray-500 mt-1">Encontre seu novo melhor amigo hoje!</p>
        </header>

        <!-- Barra de Pesquisa e Filtros -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <i data-lucide="Search" class="w-5 h-5 text-blue-500 mr-2"></i>
                Filtrar Pets
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="col-span-1 md:col-span-2">
                    <label for="search-input" class="sr-only">Pesquisar por Nome, Raça ou Tipo</label>
                    <div class="relative">
                        <input type="text" id="search-input" placeholder="Nome, Raça ou Tipo..."
                               class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <i data-lucide="Search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"></i>
                    </div>
                </div>
                <div>
                    <label for="type-select" class="sr-only">Filtrar por Tipo</label>
                    <select id="type-select" class="w-full p-3 border border-gray-300 rounded-lg appearance-none bg-white pr-8">
                        <option value="">Todos os Tipos</option>
                        <option value="Cachorro">Cachorro</option>
                        <option value="Gato">Gato</option>
                        <option value="Pássaro">Pássaro</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div>
                    <button id="add-pet-btn" class="w-full p-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-colors flex items-center justify-center">
                        <i data-lucide="PlusCircle" class="w-5 h-5 mr-2"></i>
                        Adicionar Pet de Exemplo
                    </button>
                </div>
            </div>
        </div>

        <!-- Lista de Pets -->
        <div id="pets-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Os cartões de pet serão injetados aqui -->
        </div>

        <!-- Mensagem de Sem Resultados -->
        <div id="no-results" class="hidden text-center py-20 bg-white rounded-xl shadow-lg mt-8">
            <i data-lucide="AlertCircle" class="w-12 h-12 text-yellow-500 mx-auto mb-4"></i>
            <h3 class="text-2xl font-bold text-gray-700">Nenhum Pet Encontrado</h3>
            <p class="text-gray-500 mt-2">Tente ajustar seus filtros de pesquisa.</p>
        </div>
        
        <!-- Mensagem de Inicialização / Falha -->
        <div id="initial-message" class="text-center py-20 bg-white rounded-xl shadow-lg mt-8">
            <p class="text-gray-600">Erro ao conectar. Veja o console para detalhes.</p>
        </div>
    </div>

    <!-- Scripts do Firebase e Lógica da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Importa getAuth e getFirestore, mas ignora a autenticação real por causa do erro.
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, doc, setDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Variáveis Globais ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // A token de autenticação é irrelevante agora, mas mantida por segurança do ambiente.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Configuração de fallback para o Firebase, usada se o ambiente não fornecer a configuração.
        const fallbackConfig = {
            apiKey: "AIzaSy_FALLBACK_KEY", // Esta chave está causando o erro, mas é mantida por requisito do ambiente.
            authDomain: "fallback.firebaseapp.com",
            projectId: "fallback-project-id",
            storageBucket: "fallback.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:fallbacktoken123"
        };
        
        // Determina a configuração: usa a fornecida pelo ambiente ou a de fallback.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(fallbackConfig));


        let app, db, auth;
        // Definimos um userId fake, já que não estamos autenticando de verdade.
        let userId = 'anon-user-' + crypto.randomUUID(); 
        let allPets = []; 
        let isAuthReady = false;

        // Elementos do DOM
        const petsList = document.getElementById('pets-list');
        const searchInput = document.getElementById('search-input');
        const typeSelect = document.getElementById('type-select');
        const noResults = document.getElementById('no-results');
        const initialMessage = document.getElementById('initial-message');
        const loadingOverlay = document.getElementById('loading-overlay');
        const addPetBtn = document.getElementById('add-pet-btn');
        
        // --- FUNÇÕES DE UTILIDADE ---

        /**
         * Gera um URL do WhatsApp para contato.
         * @param {string} whatsapp - Número do WhatsApp (somente dígitos).
         * @param {string} petName - Nome do pet para a mensagem.
         */
        function getWhatsappLink(whatsapp, petName) {
            // Remove caracteres não-dígitos
            const cleanNumber = whatsapp.replace(/\D/g, '');
            // Codifica a mensagem de interesse
            const message = encodeURIComponent(`Olá, vi o anúncio no Adote um Amigo e tenho interesse em adotar o(a) ${petName}. Poderia me dar mais informações?`);
            return `https://wa.me/${cleanNumber}?text=${message}`;
        }
        
        /**
         * Inicializa o Firebase e a conexão com o Firestore (ignora Auth).
         */
        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase Config não está disponível.");
                initialMessage.textContent = "Erro: Configuração do Firebase não encontrada.";
                loadingOverlay.classList.add('hidden'); 
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // CORREÇÃO CRÍTICA: Ignora a autenticação (Auth) que está falhando no ambiente de teste.
                // O código simplesmente assume que está pronto para ler dados públicos.
                isAuthReady = true; 
                console.log("Firebase inicializado. Autenticação ignorada para testes.");

                // Chama a escuta de dados imediatamente
                setupListeners();

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                initialMessage.textContent = "Erro ao conectar. Veja o console para detalhes.";
                loadingOverlay.classList.add('hidden');
            }
        }
        
        /**
         * Define o listener de dados em tempo real.
         */
        function setupListeners() {
            if (!db || !isAuthReady) {
                console.log("DB ou Inicialização não prontos.");
                return;
            }

            // O caminho da coleção é público para que todos vejam os pets
            const petsColRef = collection(db, `artifacts/${appId}/public/data/pets`);
            const petsQuery = query(petsColRef);

            initialMessage.classList.add('hidden');
            
            // Ouve o banco de dados em tempo real
            onSnapshot(petsQuery, (snapshot) => {
                
                allPets = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`Pets carregados: ${allPets.length}`);
                
                // Aplica filtros ao carregar (para inicializar a lista)
                applyFilters();

                // Esconde a tela de carregamento IMEDIATAMENTE após o carregamento dos dados
                loadingOverlay.classList.add('hidden');
            }, (error) => {
                console.error("Erro ao ouvir a coleção de pets:", error);
                initialMessage.classList.remove('hidden');
                initialMessage.textContent = `Erro ao carregar dados: ${error.message}`;
                // Esconde a tela de carregamento mesmo em caso de erro
                loadingOverlay.classList.add('hidden');
            });
        }

        /**
         * Filtra os pets e renderiza a lista.
         */
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedType = typeSelect.value.toLowerCase();

            const filteredPets = allPets.filter(pet => {
                const matchesSearch = !searchTerm || 
                    pet.name.toLowerCase().includes(searchTerm) ||
                    pet.breed.toLowerCase().includes(searchTerm) ||
                    pet.type.toLowerCase().includes(searchTerm);

                const matchesType = !selectedType || pet.type.toLowerCase() === selectedType;

                return matchesSearch && matchesType;
            });

            renderPets(filteredPets);
        }

        /**
         * Renderiza a lista de pets no DOM.
         * @param {Array<Object>} pets - Lista de objetos pet a serem renderizados.
         */
        function renderPets(pets) {
            petsList.innerHTML = ''; // Limpa a lista atual
            
            if (pets.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
            }

            pets.forEach(pet => {
                const petCard = document.createElement('div');
                petCard.className = 'pet-card rounded-xl overflow-hidden shadow-lg hover:shadow-xl';
                
                // Determina o ícone e cor do tipo
                let typeIcon = 'PawPrint';
                let typeColor = 'text-gray-500';
                if (pet.type === 'Cachorro') { typeIcon = 'Dog'; typeColor = 'text-blue-500'; }
                else if (pet.type === 'Gato') { typeIcon = 'Cat'; typeColor = 'text-pink-500'; }
                else if (pet.type === 'Pássaro') { typeIcon = 'Bird'; typeColor = 'text-green-500'; }

                petCard.innerHTML = `
                    <!-- Imagem do Pet (Placeholder Simples) -->
                    <img src="${pet.photoUrl || 'https://placehold.co/600x400/eeeeee/333333?text=Foto+do+Pet'}" 
                         alt="Foto de ${pet.name}" class="w-full h-48 object-cover object-center"
                         onerror="this.onerror=null; this.src='https://placehold.co/600x400/eeeeee/333333?text=Foto+Indisponível';"
                    >
                    
                    <div class="p-6">
                        <!-- Nome e Tipo -->
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-2xl font-bold text-gray-800">${pet.name}</h3>
                            <span class="inline-flex items-center text-sm font-medium ${typeColor}">
                                <i data-lucide="${typeIcon}" class="w-4 h-4 mr-1"></i>
                                ${pet.type}
                            </span>
                        </div>
                        
                        <!-- Detalhes -->
                        <p class="text-gray-600 mb-2">
                            <span class="font-semibold text-gray-700">Raça:</span> ${pet.breed}
                        </p>
                        <p class="text-gray-500 mb-4 h-12 overflow-hidden text-ellipsis">${pet.description || 'Nenhuma descrição fornecida.'}</p>
                        
                        <!-- Botão de Adoção para WhatsApp -->
                        <a href="${getWhatsappLink(pet.contactWhatsapp, pet.name)}" 
                           target="_blank" 
                           class="w-full mt-4 flex items-center justify-center px-4 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md transform hover:scale-[1.02]">
                            <i data-lucide="Heart" class="w-5 h-5 mr-2 fill-white"></i>
                            Adotar ${pet.name} (WhatsApp)
                        </a>
                    </div>
                `;
                petsList.appendChild(petCard);
            });
            
            // Re-renderiza os ícones Lucide após injetar o HTML
            window.createIcons();
        }

        /**
         * Adiciona alguns pets de exemplo ao Firestore para demonstração.
         */
        async function addSampleData() {
            if (!db) {
                alertUser("Atenção", "A conexão com o banco de dados não está pronta. Tente novamente.", "text-yellow-500");
                return;
            }

            const petsColRef = collection(db, `artifacts/${appId}/public/data/pets`);

            // Verifica se já existem dados para evitar duplicatas excessivas
            const snapshot = await getDocs(petsColRef);
            if (snapshot.size > 5) {
                alertUser("Atenção", "A coleção já contém dados de exemplo suficientes. Tente pesquisar!", "text-yellow-500");
                return;
            }

            const samplePets = [
                {
                    name: "Rex",
                    breed: "Labrador",
                    type: "Cachorro",
                    photoUrl: "https://placehold.co/400x300/f5a742/ffffff?text=REX",
                    contactWhatsapp: "5511987654321", // Exemplo de contato
                    description: "Rex é um labrador brincalhão e muito amigável, adora correr no parque e é ótimo com crianças. Precisa de um quintal grande.",
                    postedByUserId: userId // Usando o userId fake
                },
                {
                    name: "Mia",
                    breed: "Siamês",
                    type: "Gato",
                    photoUrl: "https://placehold.co/400x300/42b9f5/ffffff?text=MIA",
                    contactWhatsapp: "5511999998888",
                    description: "Mia é uma gata siamesa tranquila, adora cochilar no sol e é muito carinhosa. Perfeita para apartamentos.",
                    postedByUserId: userId
                },
                {
                    name: "Pipoca",
                    breed: "Calopsita",
                    type: "Pássaro",
                    photoUrl: "https://placehold.co/400x300/90ee90/000000?text=PIPOCA",
                    contactWhatsapp: "5511977776666",
                    description: "Pipoca é uma calopsita tagarela e adora cantar. Vem com uma gaiola grande e muitos brinquedos.",
                    postedByUserId: userId
                }
            ];

            try {
                for (const pet of samplePets) {
                    await addDoc(petsColRef, pet);
                }
                alertUser("Sucesso!", `${samplePets.length} pets de exemplo adicionados com sucesso.`, "text-green-500");
            } catch (error) {
                console.error("Erro ao adicionar dados de exemplo:", error);
                alertUser("Erro", "Não foi possível adicionar os dados de exemplo. Veja o console.", "text-red-500");
            }
        }
        
        /**
         * Substitui o alert() por uma mensagem modal simples.
         */
        function alertUser(title, message, iconColor) {
            const existingModal = document.getElementById('custom-modal');
            if(existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'custom-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full transform transition-all scale-100">
                    <div class="flex items-center mb-4">
                        <i data-lucide="MessageCircle" class="w-6 h-6 mr-3 ${iconColor || 'text-blue-500'}"></i>
                        <h4 class="text-xl font-bold text-gray-800">${title}</h4>
                    </div>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <button id="modal-close-btn" class="w-full py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-semibold">
                        Entendi
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            window.createIcons(); // Renderiza os ícones

            document.getElementById('modal-close-btn').onclick = () => modal.remove();
        }

        // --- EVENT LISTENERS ---
        searchInput.addEventListener('input', applyFilters);
        typeSelect.addEventListener('change', applyFilters);
        addPetBtn.addEventListener('click', addSampleData);
        
        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            initFirebase();
        };

    </script>
</body>
</html>